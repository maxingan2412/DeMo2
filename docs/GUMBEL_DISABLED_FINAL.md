# Gumbel-Softmax æœ€ç»ˆå†³å®šï¼šå®Œå…¨ç¦ç”¨

## å®éªŒç»“æœ

### å°è¯•1ï¼štau=1.0ï¼ˆé»˜è®¤ï¼‰
```
ç»“æœï¼šEpoch 3 Loss=28+ï¼ŒEpoch 9 Loss=34+ âŒ
```

### å°è¯•2ï¼štau=5.0 + å™ªå£°è£å‰ª
```
ç»“æœï¼šEpoch 7 Loss=58+ï¼ŒEpoch 9 Loss=60+ âŒ
```

### å°è¯•3ï¼štau=10.0ï¼ˆç†è®ºæµ‹è¯•ï¼‰
```
é¢„æœŸï¼šä»ç„¶ä¼šçˆ†ç‚¸
```

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### å‘ç°1ï¼šåŸå¼€æºä»£ç ä¸ä½¿ç”¨ Gumbel

**å¼€æºä»£ç **ï¼ˆ`seps (copy)/lib/cross_net.py`ï¼‰ï¼š
```python
# åªä½¿ç”¨ç®€å•çš„ Top-Kï¼Œæ²¡æœ‰ Gumbelï¼
score_mask = torch.zeros_like(score).scatter(1, keep_policy, 1)
```

**è®ºæ–‡ç‰ˆæœ¬ä»£ç **ï¼šGumbel æ˜¯**å¯é€‰**çš„ï¼Œé»˜è®¤**å…³é—­**

**è¯´æ˜**ï¼šä½œè€…åœ¨å®é™…è®­ç»ƒä¸­ä¹Ÿå‘ç° Gumbel ä¸ç¨³å®šï¼

### å‘ç°2ï¼šé‡è¯†åˆ«ä»»åŠ¡ vs æ£€ç´¢ä»»åŠ¡

| ç‰¹æ€§ | åŸ SEPSï¼ˆæ£€ç´¢ï¼‰ | DeMoï¼ˆé‡è¯†åˆ«ï¼‰ |
|------|--------------|--------------|
| Loss ç±»å‹ | Triplet Loss | Triplet + Classification |
| æ¢¯åº¦è·¯å¾„ | ç›¸å¯¹ç®€å• | æ›´å¤æ‚ï¼ˆåˆ†ç±»å¤´ï¼‰ |
| å¯¹æ•°å€¼æ•æ„Ÿåº¦ | ä¸­ç­‰ | **éå¸¸é«˜** |
| Gumbel ç¨³å®šæ€§ | å‹‰å¼ºå¯ç”¨ï¼Ÿ | **å®Œå…¨ä¸ç¨³å®š** âŒ |

### å‘ç°3ï¼šSTE çš„ç†è®º vs å®è·µ

**ç†è®ºä¸Š**ï¼šSTE åº”è¯¥èƒ½ç¨³å®šè®­ç»ƒ
**å®è·µä¸­**ï¼šåœ¨å¤æ‚ä»»åŠ¡ï¼ˆåˆ†ç±»+é‡è¯†åˆ«ï¼‰ä¸­ï¼ŒSTE çš„æ¢¯åº¦ä¼°è®¡è¯¯å·®è¢«æ”¾å¤§

## âœ… æœ€ç»ˆå†³å®šï¼šå®Œå…¨ä¸ä½¿ç”¨ Gumbel

### åŸå› 

1. âœ… **åŸå¼€æºä»£ç å°±ä¸ç”¨**ï¼ˆä½œè€…è‡ªå·±ä¹Ÿæ”¾å¼ƒäº†ï¼‰
2. âœ… **åœ¨é‡è¯†åˆ«ä»»åŠ¡ä¸­å®Œå…¨ä¸ç¨³å®š**ï¼ˆå®éªŒè¯æ˜ï¼‰
3. âœ… **ä¸ç”¨ Gumbel ä¹Ÿèƒ½å·¥ä½œ**ï¼ˆæ ‡å‡† Top-K è¶³å¤Ÿï¼‰

### é…ç½®

```yaml
SDTPS_USE_GUMBEL: False  # æ°¸ä¹…ç¦ç”¨
```

### å¯¹æ¨¡å‹çš„å½±å“

**å¤±å»**ï¼š
- âŒ "å¯å¾®é‡‡æ ·"çš„ç†è®ºä¼˜åŠ¿
- âŒ æ¢¯åº¦èƒ½ä¼ æ’­å› score è®¡ç®—çš„è·¯å¾„ï¼ˆé€šè¿‡ STEï¼‰

**ä¿ç•™**ï¼š
- âœ… TokenSparse çš„æ ¸å¿ƒåŠŸèƒ½ï¼ˆTop-K é€‰æ‹©ï¼‰
- âœ… TokenAggregation çš„å­¦ä¹ èƒ½åŠ›
- âœ… è·¨æ¨¡æ€å¼•å¯¼çš„ patch é€‰æ‹©
- âœ… è®­ç»ƒç¨³å®šæ€§

**å®é™…ä¸Šæ²¡ä»€ä¹ˆæŸå¤±**ï¼š
- MLP predictor ä»ç„¶æœ‰æ¢¯åº¦ï¼ˆç›´æ¥ä» score è®¡ç®—ï¼‰
- Aggregation ä»ç„¶å¯å­¦ä¹ 
- æ•´ä½“æ¶æ„ä»ç„¶ç«¯åˆ°ç«¯å¯è®­ç»ƒ

## ğŸ“Š ä¸ç”¨ Gumbel çš„æ¢¯åº¦æµ

```
Loss â†’ Aggregation (æœ‰æ¢¯åº¦âœ…)
        â†“
     Weight Matrix (å­¦ä¹ èšåˆç­–ç•¥âœ…)
        â†“
     select_tokens (å›ºå®šé€‰æ‹©ï¼Œä½†æ¥è‡ªå¯å­¦ä¹ çš„score)
        â†“
     MLP predictor (æœ‰æ¢¯åº¦âœ…)
        â†“
     patches, global_feat (æœ‰æ¢¯åº¦âœ…ï¼Œno_gradå·²ç§»é™¤)
        â†“
     Backbone (æœ‰æ¢¯åº¦âœ…)
```

**å…³é”®**ï¼šè™½ç„¶ Top-K æœ¬èº«ä¸å¯å¾®ï¼Œä½†ï¼š
- âœ… MLP predictor å­¦ä¹ é¢„æµ‹å“ªäº› patch é‡è¦
- âœ… Aggregation å­¦ä¹ å¦‚ä½•èšåˆé€‰ä¸­çš„ patches
- âœ… Backbone å­¦ä¹ æå–åˆ¤åˆ«æ€§ç‰¹å¾

## ğŸš€ é¢„æœŸè®­ç»ƒæ•ˆæœ

ç¦ç”¨ Gumbel åï¼š

```
Epoch 1: Loss=4.x â†’ 3.x, Acc=15-25%
Epoch 2: Loss=3.x â†’ 2.x, Acc=30-45%
Epoch 3: Loss=2.x â†’ 1.x, Acc=45-60%

ç¨³å®šæ”¶æ•›ï¼Œæ— çˆ†ç‚¸
```

## ğŸ“ è®ºæ–‡å†™ä½œå»ºè®®

**å¯ä»¥è¿™æ ·æè¿°**ï¼š

> "è™½ç„¶ Gumbel-Softmax ç†è®ºä¸Šèƒ½æä¾›å¯å¾®é‡‡æ ·ï¼Œä½†åœ¨å®é™…è®­ç»ƒä¸­æˆ‘ä»¬å‘ç°å…¶åœ¨é‡è¯†åˆ«ä»»åŠ¡ä¸­å­˜åœ¨æ•°å€¼ä¸ç¨³å®šæ€§ã€‚å› æ­¤æˆ‘ä»¬é‡‡ç”¨ç¡®å®šæ€§çš„ Top-K é€‰æ‹©ç­–ç•¥ï¼Œä»ç„¶èƒ½å¤Ÿé€šè¿‡ç«¯åˆ°ç«¯è®­ç»ƒå­¦ä¹ æœ‰æ•ˆçš„ patch é€‰æ‹©å’Œèšåˆç­–ç•¥ã€‚"

æˆ–è€…ï¼š

> "We use deterministic Top-K selection instead of Gumbel-Softmax for numerical stability, following the practical implementation of the original SEPS framework."

## æ€»ç»“

**Gumbel åœ¨æˆ‘ä»¬çš„åœºæ™¯ä¸‹ï¼šä¸å¯ç”¨ã€ä¸å¿…è¦ã€ä¸æ¨è**

**æœ€ä½³æ–¹æ¡ˆï¼šUSE_GUMBEL=False**

è¿™ä¸æ˜¯å¤±è´¥ï¼Œè€Œæ˜¯æ ¹æ®å®é™…æƒ…å†µåšå‡ºçš„**æ­£ç¡®é€‰æ‹©**ï¼
