# DGAF 架构图解

## 原论文 AGFN 架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        AGFN Architecture (原论文)                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌─────────┐   ┌─────────┐   ┌─────────┐                              │
│   │  Text   │   │  Audio  │   │ Visual  │                              │
│   └────┬────┘   └────┬────┘   └────┬────┘                              │
│        │             │             │                                    │
│        ▼             ▼             ▼                                    │
│   ┌─────────┐   ┌─────────┐   ┌─────────┐                              │
│   │  BERT   │   │ BiLSTM  │   │ BiLSTM  │   Unimodal Encoders          │
│   └────┬────┘   └────┬────┘   └────┬────┘                              │
│        │             │             │                                    │
│        ▼             ▼             ▼                                    │
│      h_T           h_A           h_V        (B, C) each                │
│        │             │             │                                    │
│        └─────────────┼─────────────┘                                    │
│                      │                                                  │
│                      ▼                                                  │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │            Dual-Gated Adaptive Fusion (DGAF)                     │  │
│   │                                                                  │  │
│   │   ┌────────────────────┐    ┌────────────────────┐              │  │
│   │   │ Information Entropy│    │ Modality Importance│              │  │
│   │   │    Gate (IEG)      │    │    Gate (MIG)      │              │  │
│   │   │                    │    │                    │              │  │
│   │   │ H(h_m) = -Σp·logp  │    │ g = σ(MLP(concat)) │              │  │
│   │   │ w = softmax(z·e^-H)│    │ h' = g ⊙ h         │              │  │
│   │   │ h_entropy = Σw·h   │    │ h_importance = W·h'│              │  │
│   │   └─────────┬──────────┘    └─────────┬──────────┘              │  │
│   │             │                         │                          │  │
│   │             └────────────┬────────────┘                          │  │
│   │                          ▼                                       │  │
│   │            h_fused = α·h_entropy + (1-α)·h_importance            │  │
│   │                          │                                       │  │
│   └──────────────────────────┼───────────────────────────────────────┘  │
│                              ▼                                          │
│                    ┌─────────────────┐                                  │
│                    │ Prediction Head │                                  │
│                    └────────┬────────┘                                  │
│                             ▼                                           │
│                      Sentiment Score                                    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 我们的 DeMo + DGAF 架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     DeMo + DGAF Architecture (我们的实现)                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌─────────┐   ┌─────────┐   ┌─────────┐                              │
│   │   RGB   │   │   NIR   │   │   TIR   │                              │
│   └────┬────┘   └────┬────┘   └────┬────┘                              │
│        │             │             │                                    │
│        ▼             ▼             ▼                                    │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │              Shared ViT Backbone (CLIP/ImageNet)                 │  │
│   │                                                                  │  │
│   │   RGB_cash (B,N,C)    NI_cash (B,N,C)    TI_cash (B,N,C)        │  │
│   │   RGB_global (B,C)    NI_global (B,C)    TI_global (B,C)        │  │
│   └────┬────────────────────────┬────────────────────────┬──────────┘  │
│        │                        │                        │              │
│        ▼                        ▼                        ▼              │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                    SDTPS (Token Selection)                       │  │
│   │                                                                  │  │
│   │   1. 计算 token 重要性分数                                       │  │
│   │   2. 选择 Top-K 重要 tokens                                      │  │
│   │   3. Token 聚合增强                                              │  │
│   │                                                                  │  │
│   │   RGB_enhanced (B,K+1,C)  NI_enhanced (B,K+1,C)  TI_enhanced    │  │
│   └────┬────────────────────────┬────────────────────────┬──────────┘  │
│        │                        │                        │              │
│        ▼                        ▼                        ▼              │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                       Mean Pooling                               │  │
│   │                                                                  │  │
│   │   RGB_sdtps (B,C)       NI_sdtps (B,C)       TI_sdtps (B,C)     │  │
│   └────┬────────────────────────┬────────────────────────┬──────────┘  │
│        │                        │                        │              │
│        └────────────────────────┼────────────────────────┘              │
│                                 │                                       │
│                                 ▼                                       │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │       ★ DualGatedPostFusion (替代简单 concat) ★                  │  │
│   │                                                                  │  │
│   │   ┌─────────────────────────────────────────────────────────┐   │  │
│   │   │              Information Entropy Gate (IEG)              │   │  │
│   │   │                                                          │   │  │
│   │   │   H_rgb = entropy(RGB_sdtps)                             │   │  │
│   │   │   H_nir = entropy(NI_sdtps)                              │   │  │
│   │   │   H_tir = entropy(TI_sdtps)                              │   │  │
│   │   │                                                          │   │  │
│   │   │   score_m = z_m · exp(-H_m / τ)                          │   │  │
│   │   │   w = softmax([score_rgb, score_nir, score_tir])         │   │  │
│   │   │   h_entropy = w_rgb·RGB + w_nir·NI + w_tir·TI            │   │  │
│   │   └──────────────────────────────────────────────────────────┘   │  │
│   │                                                                  │  │
│   │   ┌─────────────────────────────────────────────────────────┐   │  │
│   │   │              Modality Importance Gate (MIG)              │   │  │
│   │   │                                                          │   │  │
│   │   │   h_concat = concat([RGB, NI, TI])  # (B, 3C)            │   │  │
│   │   │   gates = sigmoid(MLP(h_concat))    # (B, 3)             │   │  │
│   │   │   h_importance = g_rgb·RGB + g_nir·NI + g_tir·TI         │   │  │
│   │   └──────────────────────────────────────────────────────────┘   │  │
│   │                                                                  │  │
│   │   ┌─────────────────────────────────────────────────────────┐   │  │
│   │   │                  Adaptive Fusion                         │   │  │
│   │   │                                                          │   │  │
│   │   │   α = sigmoid(_alpha)  # 可学习参数                      │   │  │
│   │   │   h_fused = α · h_entropy + (1-α) · h_importance         │   │  │
│   │   │                                                          │   │  │
│   │   │   h_enhance = LayerNorm(Linear(h_fused))                 │   │  │
│   │   │                                                          │   │  │
│   │   │   output = concat([RGB + h_enhance,                      │   │  │
│   │   │                    NI + h_enhance,                        │   │  │
│   │   │                    TI + h_enhance])  # (B, 3C)           │   │  │
│   │   └──────────────────────────────────────────────────────────┘   │  │
│   │                                                                  │  │
│   └──────────────────────────────────────────────────────────────────┘  │
│                                 │                                       │
│                                 ▼                                       │
│                    ┌────────────────────────┐                           │
│                    │  BatchNorm + Classifier │                          │
│                    │       (3C → Classes)    │                          │
│                    └───────────┬────────────┘                           │
│                                │                                        │
│                                ▼                                        │
│                    ┌────────────────────────┐                           │
│                    │   ID Loss + Triplet    │                           │
│                    └────────────────────────┘                           │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 信息熵计算示意

```
特征向量 h = [0.1, 0.5, 0.2, 0.15, 0.05]  # 假设 C=5

Step 1: 取绝对值并归一化为概率分布
  |h| = [0.1, 0.5, 0.2, 0.15, 0.05]
  p = |h| / sum(|h|) = [0.1, 0.5, 0.2, 0.15, 0.05]

Step 2: 计算信息熵
  H = -Σ p · log(p)
  H = -(0.1·log(0.1) + 0.5·log(0.5) + ... + 0.05·log(0.05))
  H ≈ 1.36 (低熵 = 高确定性)

Step 3: 熵调制得分
  z = mean(Linear(h))  # 投影后取均值
  score = z · exp(-H/τ)  # τ=1.0

  低熵 → exp(-H/τ) 大 → score 大 → 权重高
  高熵 → exp(-H/τ) 小 → score 小 → 权重低
```

## 原始 concat vs DGAF 对比

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        原始方式：简单 concat                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   RGB_sdtps ────┐                                                       │
│                 │                                                       │
│   NI_sdtps  ────┼──► concat ──► [RGB | NI | TI]  (B, 3C)               │
│                 │                                                       │
│   TI_sdtps  ────┘                                                       │
│                                                                         │
│   问题：                                                                │
│   - 假设三个模态同等重要                                                │
│   - 无法抑制噪声/低质量模态                                             │
│   - 模态缺失时性能下降明显                                              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                        新方式：DGAF 自适应融合                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   RGB_sdtps ────┐      ┌─────────────────────────────────────────────┐  │
│                 │      │         DualGatedPostFusion                 │  │
│   NI_sdtps  ────┼──►   │                                             │  │
│                 │      │  ┌───────────┐    ┌───────────────┐         │  │
│   TI_sdtps  ────┘      │  │    IEG    │    │     MIG       │         │  │
│                        │  │           │    │               │         │  │
│                        │  │  熵加权   │    │  重要性门控   │         │  │
│                        │  │  w·h_m    │    │  g·h_m        │         │  │
│                        │  └─────┬─────┘    └───────┬───────┘         │  │
│                        │        │                  │                 │  │
│                        │        └────────┬─────────┘                 │  │
│                        │                 ▼                           │  │
│                        │    h_fused = α·h_ent + (1-α)·h_imp          │  │
│                        │                 │                           │  │
│                        │                 ▼                           │  │
│                        │    [RGB+h_enh | NI+h_enh | TI+h_enh]       │  │
│                        │                                             │  │
│                        └─────────────────────────────────────────────┘  │
│                                                                         │
│   优势：                                                                │
│   - 低熵模态获得更高权重 (IEG)                                          │
│   - 样本级别动态调整 (MIG)                                              │
│   - 可学习的平衡参数 α                                                  │
│   - 增强后拼接保留各模态信息                                            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```
