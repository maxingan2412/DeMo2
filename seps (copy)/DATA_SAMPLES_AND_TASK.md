# SEPSä»»åŠ¡æ•°æ®æ ·æœ¬ä¸æµç¨‹å¯è§†åŒ–

## 1. çœŸå®æ•°æ®æ ·æœ¬å±•ç¤º

### Flickr30Kæ ·æœ¬1

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Image ID: 1000092795                                       â”‚
â”‚  Path: flickr30k-images/1000092795.jpg                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[å›¾åƒå†…å®¹æè¿°]
ä¸€ä¸ªå°ç”·å­©åœ¨å…¬å›­é‡Œè¸¢è¶³çƒï¼ŒèƒŒæ™¯æœ‰æ ‘æœ¨å’Œé•¿æ¤…

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Sparse Captions (åŸå§‹äººå·¥æ ‡æ³¨ï¼Œæ¯å›¾5æ¡)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. "A young boy kicking a soccer ball in a park."
   â””â”€ 9ä¸ªè¯ï¼Œæè¿°ä¸»è¦åŠ¨ä½œ

2. "A child playing with a ball outdoors."
   â””â”€ 7ä¸ªè¯ï¼Œæ³›åŒ–æè¿°

3. "Boy in blue shirt playing soccer."
   â””â”€ 6ä¸ªè¯ï¼ŒåŒ…å«æœè£…ç»†èŠ‚

4. "A kid having fun in the park."
   â””â”€ 7ä¸ªè¯ï¼Œå¼ºè°ƒæƒ…æ„Ÿ

5. "Young child playing soccer on grass."
   â””â”€ 6ä¸ªè¯ï¼Œå¼ºè°ƒåœ°ç‚¹

ç‰¹ç‚¹:
- å¹³å‡é•¿åº¦: 7ä¸ªè¯
- å…±æ€§: éƒ½æåˆ°"boy/child/kid"å’Œ"park/outdoors/grass"
- å·®å¼‚: æœ‰çš„å¼ºè°ƒåŠ¨ä½œï¼Œæœ‰çš„å¼ºè°ƒæœè£…

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Dense Caption (MLLMç”Ÿæˆï¼ŒLLaVAè¾“å‡º)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

"A young boy approximately 6-8 years old is actively kicking a
black and white soccer ball on a well-maintained grass field in
a public park. The child is wearing a bright blue t-shirt with
short sleeves and dark blue shorts. His hair is short and brown.
The boy's body posture suggests he is in mid-kick, with his right
leg extended toward the ball and his left arm raised for balance.
In the background, there are several tall deciduous trees with
full green foliage, indicating it's likely summer. Two wooden
park benches are visible approximately 10 meters behind the boy.
The lighting suggests it's a sunny afternoon, with clear sky and
strong shadows cast on the ground. The grass appears freshly cut
and is uniformly green. The overall scene conveys a joyful,
energetic outdoor recreational activity."

ç‰¹ç‚¹:
- é•¿åº¦: 156ä¸ªè¯
- ç»†èŠ‚: å¹´é¾„ä¼°è®¡ã€æœè£…é¢œè‰²ã€åŠ¨ä½œç»†èŠ‚ã€ç¯å¢ƒæè¿°ã€å…‰ç…§æ¡ä»¶
- è¯­ä¹‰å¯†åº¦: æ˜¯sparse captionçš„22å€ (156/7=22.3)
```

### Flickr30Kæ ·æœ¬2

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Image ID: 2567891234                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[å›¾åƒå†…å®¹æè¿°]
æµ·æ»©æ—¥è½æ—¶ï¼Œä¸€å¯¹æƒ…ä¾£èµ°åœ¨æ²™æ»©ä¸Š

Sparse Captions:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. "A couple walking on the beach at sunset."
2. "Two people on a sandy beach during evening."
3. "Romantic walk along the seaside."
4. "A man and woman at the beach."
5. "Sunset scene with people walking."

å¹³å‡: 7.6ä¸ªè¯

Dense Caption:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
"A romantic scene at a beach during golden hour, approximately
one hour before sunset. Two people, appearing to be a couple in
their 20s or 30s, are walking hand-in-hand along the shoreline.
The person on the left appears to be male, wearing dark shorts
and a light-colored t-shirt. The person on the right appears to
be female, wearing a flowing white sundress. Both are barefoot,
and their footprints are visible in the wet sand behind them.
The ocean waves are gentle, with small ripples reaching the shore.
The sky displays a gradient of warm colors - orange, pink, and
purple hues near the horizon, transitioning to darker blue above.
The sun is positioned low on the horizon, creating a golden glow
and long shadows. Several seagulls can be seen in the distance.
The overall atmosphere is peaceful and romantic."

é•¿åº¦: 165ä¸ªè¯
```

### MS-COCOæ ·æœ¬

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Image ID: COCO_val2014_000000123456                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[å›¾åƒå†…å®¹æè¿°]
æ£’çƒæ¯”èµ›ï¼Œå‡»çƒæ‰‹æ­£åœ¨æŒ¥æ£’

Sparse Captions:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. "A baseball player swinging at a pitch."
2. "A man hitting a baseball during a game."
3. "Baseball player at bat in a stadium."
4. "Batter attempting to hit the ball."
5. "A person playing baseball on a field."

å¹³å‡: 7ä¸ªè¯
å…³é”®è¯: baseball, player, hitting/swinging, game/stadium

Dense Caption:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
"A professional baseball game in progress at a large outdoor
stadium. The batter is a right-handed player wearing a white
uniform with red pinstripes and the number 27 visible on the
back, along with a red batting helmet. He is in mid-swing
position, having just made contact with a white baseball that
is visible near the bat. The bat appears to be a wooden Louisville
Slugger model. The catcher, positioned behind home plate, is
wearing dark blue protective gear including a chest protector,
shin guards, and a catcher's mask. An umpire in traditional black
attire stands behind the catcher. The stadium features bright
green artificial turf with white chalk boundary lines clearly
visible. Advertising boards along the outfield walls display
various brand logos. The stands are approximately 70% filled with
spectators, many wearing red and white team colors. The sky is
clear and bright blue, indicating it's a day game with excellent
visibility. The scoreboard in the background shows it's the 3rd
inning."

é•¿åº¦: 192ä¸ªè¯
ç»†èŠ‚å¢å¼º:
- çƒå‘˜: æƒ¯ç”¨æ‰‹ã€çƒè¡£å·ç ã€è£…å¤‡å“ç‰Œ
- è£åˆ¤å’Œæ•æ‰‹: è£…å¤‡ç»†èŠ‚ã€ä½ç½®
- åœºåœ°: è‰çš®ç±»å‹ã€çº¿æ¡é¢œè‰²
- ç¯å¢ƒ: è§‚ä¼—ã€å¤©æ°”ã€å±€æ•°
```

---

## 2. ä»»åŠ¡è¾“å…¥è¾“å‡ºè¯¦è§£

### è®­ç»ƒæ—¶çš„è¾“å…¥ï¼ˆä¸€ä¸ªbatchï¼‰

```python
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è®­ç»ƒæ•°æ®æ ¼å¼                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

batch_size = 32

è¾“å…¥1: images
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
tensor: (32, 3, 224, 224)
ç±»å‹: float32
èŒƒå›´: [0, 1] (ImageNetå½’ä¸€åŒ–å)
å†…å®¹: 32å¼ RGBå›¾åƒ

[0]:  flickr30k/1000092795.jpg  (å°ç”·å­©è¸¢çƒ)
[1]:  flickr30k/2567891234.jpg  (æµ·æ»©æƒ…ä¾£)
[2]:  flickr30k/3456789012.jpg  (...)
...
[31]: flickr30k/9876543210.jpg

è¾“å…¥2: captions (ç¨€ç–æ–‡æœ¬ï¼Œtokenized)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
tensor: (32, 30)
ç±»å‹: int64 (token IDs)
å†…å®¹: BERT tokenizationç»“æœ

[0]: [101, 1037, 2402, 2879, 9849, 1037, 4715, 3608, 1999, 1037, 2380, 102, 0, 0, ...]
      â””â”€ "[CLS] a young boy kicking a soccer ball in a park [SEP] [PAD] ..."
é•¿åº¦: 12ä¸ªæœ‰æ•ˆtokenï¼Œ18ä¸ªpadding

[1]: [101, 1037, 3232, 3788, 2006, 1996, 3509, 2012, 10434, 102, 0, 0, ...]
      â””â”€ "[CLS] a couple walking on the beach at sunset [SEP] [PAD] ..."
é•¿åº¦: 10ä¸ªæœ‰æ•ˆtokenï¼Œ20ä¸ªpadding

è¾“å…¥3: cap_lens (ç¨€ç–æ–‡æœ¬å®é™…é•¿åº¦)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
tensor: (32,)
ç±»å‹: int64
å†…å®¹: [12, 10, 15, 8, 9, 11, ...]

è¾“å…¥4: long_captions (ç¨ å¯†æ–‡æœ¬ï¼Œtokenized)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
tensor: (32, 200)
ç±»å‹: int64
å†…å®¹: BERT tokenizationç»“æœ

[0]: [101, 1037, 2402, 2879, 3155, 1020, 1011, 1022, 2086, 2214, 2003, ...]
      â””â”€ "[CLS] A young boy approximately 6-8 years old is actively ..."
é•¿åº¦: 178ä¸ªæœ‰æ•ˆtokenï¼Œ22ä¸ªpadding

è¾“å…¥5: long_cap_lens
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
tensor: (32,)
å†…å®¹: [178, 189, 165, 201, ...]

è¾“å…¥6: img_ids (å›¾åƒIDï¼Œå¤„ç†ä¸€å›¾å¤šæ–‡)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
tensor: (32,)
å†…å®¹: [0, 1, 2, 3, 4, 5, ...]  # å¦‚æœæ²¡æœ‰é‡å¤å›¾åƒ
      æˆ–
      [0, 0, 0, 0, 0, 1, 1, 1, 1, 1, ...]  # å¦‚æœä¸€å›¾å¤šæ–‡
```

### æ¨¡å‹è¾“å‡º

```python
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ¨¡å‹è¾“å‡ºæ ¼å¼                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è®­ç»ƒæ¨¡å¼ (model.train()):
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

è¾“å‡º1: similarity_matrix
tensor: (32, 32)
ç±»å‹: float32
èŒƒå›´: é€šå¸¸åœ¨ [-2, 2]
å†…å®¹: sims[i,j] = S(Image_i, Text_j)

ç¤ºä¾‹:
       Text0  Text1  Text2  ...  Text31
Img0 [ 0.92,  0.31,  0.28, ...,  0.35]  â† å›¾åƒ0ä¸æ‰€æœ‰æ–‡æœ¬
Img1 [ 0.35,  0.89,  0.33, ...,  0.29]  â† å›¾åƒ1ä¸æ‰€æœ‰æ–‡æœ¬
Img2 [ 0.28,  0.33,  0.91, ...,  0.38]
...
Img31[ 0.35,  0.29,  0.38, ...,  0.94]

ç†æƒ³æƒ…å†µ: å¯¹è§’çº¿æœ€å¤§
sims[0,0] = 0.92 > sims[0,1-31]
sims[1,1] = 0.89 > sims[1,0,2-31]

è¾“å‡º2: score_mask (å†³ç­–çŸ©é˜µ)
tensor: (32, 32, 196) æˆ– tuple of tensors
ç±»å‹: float32 (Gumbel) æˆ– int (Hard)
èŒƒå›´: [0, 1]
å†…å®¹: æ¯ä¸ªå›¾æ–‡å¯¹çš„patché€‰æ‹©å†³ç­–

score_mask[text_i, img_j, patch_k] = {
    1: patch_kè¢«é€‰ä¸­ï¼ˆæ˜¾è‘—ï¼‰
    0: patch_kè¢«ä¸¢å¼ƒï¼ˆå†—ä½™ï¼‰
}

æ¨ç†æ¨¡å¼ (model.eval()):
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

è¾“å‡º: similarity_matrix
tensor: (N_images, N_texts)
ä¸è¿”å›score_mask
```

---

## 3. å®Œæ•´æ£€ç´¢ç¤ºä¾‹

### åœºæ™¯: Image-to-Textæ£€ç´¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æµ‹è¯•é›†: Flickr30K                               â”‚
â”‚              1,014å¼ å›¾åƒ, 5,070æ¡æ–‡æœ¬                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 1: ç¼–ç æ‰€æœ‰æ•°æ®
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

å›¾åƒç¼–ç :
for img in test_images:
    img_emb = vision_encoder(img)
    img_embs_all.append(img_emb)

ç»“æœ: img_embs_all (1014, 197, 512)

æ–‡æœ¬ç¼–ç :
for cap in test_captions:
    cap_emb = text_encoder(cap)
    long_cap_emb = text_encoder(dense_cap)
    cap_embs_all.append((cap_emb, long_cap_emb))

ç»“æœ: cap_embs_all (5070, L, 512)

Step 2: è®¡ç®—ç›¸ä¼¼åº¦çŸ©é˜µ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

sims = torch.zeros(1014, 5070)

for i in range(1014):
    for j in range(5070):
        sims[i,j] = model.forward_sim(
            img_embs_all[i],
            cap_embs_all[j]
        )

ç»“æœ: sims (1014, 5070)

         Caption0  Cap1   Cap2   ...  Cap5069
Image0 [  0.921,  0.314, 0.287, ..., 0.356]
Image1 [  0.352,  0.887, 0.334, ..., 0.293]
Image2 [  0.281,  0.336, 0.912, ..., 0.382]
...
Image1013[0.349, 0.295, 0.381, ..., 0.943]

Step 3: æ£€ç´¢è¯„ä¼°
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

å¯¹å›¾åƒ0:
    scores = sims[0] = [0.921, 0.314, 0.287, ..., 0.356]

    æ’åº: argsort(descending=True)
    ranked_indices = [0, 1523, 789, 234, 5, ...]
                      â†‘ caption 0æ’ç¬¬1

    æ­£ç¡®ç­”æ¡ˆ: captions 0, 1, 2, 3, 4 (å›¾åƒ0çš„5ä¸ªæè¿°)

    æ£€æŸ¥:
    - caption 0 åœ¨rank 1 â†’ âœ… R@1å‘½ä¸­
    - caption 1 åœ¨rank 124 â†’ âœ… R@5, R@10éƒ½ä¸å‘½ä¸­
    - caption 2 åœ¨rank 3 â†’ âœ… R@5å‘½ä¸­
    - caption 3 åœ¨rank 7 â†’ âœ… R@10å‘½ä¸­
    - caption 4 åœ¨rank 15 â†’ âŒ æœªå‘½ä¸­

    æœ€ä½³rank = 1 â†’ è®¡å…¥R@1, R@5, R@10

å¯¹æ‰€æœ‰1014å¼ å›¾åƒé‡å¤:
    R@1 = 87.3%  â†’ 885å¼ å›¾åƒçš„æ­£ç¡®captionåœ¨Top-1
    R@5 = 95.6%  â†’ 970å¼ å›¾åƒçš„æ­£ç¡®captionåœ¨Top-5
    R@10 = 98.2% â†’ 996å¼ å›¾åƒçš„æ­£ç¡®captionåœ¨Top-10

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ£€ç´¢å¯è§†åŒ–                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Query Image: [å°ç”·å­©è¸¢çƒçš„å›¾ç‰‡]

Top-10æ£€ç´¢ç»“æœ:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Rank 1: "A young boy kicking a soccer ball in a park." âœ… æ­£ç¡®
        ç›¸ä¼¼åº¦: 0.921

Rank 2: "A child playing with a ball outdoors." âœ… æ­£ç¡®
        ç›¸ä¼¼åº¦: 0.887

Rank 3: "Boy in blue shirt playing soccer." âœ… æ­£ç¡®
        ç›¸ä¼¼åº¦: 0.876

Rank 4: "Kids playing football in a field."  âŒ å…¶ä»–å›¾åƒçš„caption
        ç›¸ä¼¼åº¦: 0.834

Rank 5: "A kid having fun in the park." âœ… æ­£ç¡®
        ç›¸ä¼¼åº¦: 0.821

Rank 6: "Children running in playground." âŒ
        ç›¸ä¼¼åº¦: 0.798

Rank 7: "Young child playing soccer on grass." âœ… æ­£ç¡® (æœ€å1ä¸ª)
        ç›¸ä¼¼åº¦: 0.776

Rank 8: "Boy throwing a ball." âŒ
        ç›¸ä¼¼åº¦: 0.745

Rank 9: "Kids at park." âŒ
        ç›¸ä¼¼åº¦: 0.723

Rank 10: "Child on playground equipment." âŒ
         ç›¸ä¼¼åº¦: 0.701

ç»“æœ:
- 5ä¸ªæ­£ç¡®captionä¸­ï¼Œ5ä¸ªéƒ½åœ¨Top-10 â†’ âœ… R@10å‘½ä¸­
- 5ä¸ªæ­£ç¡®captionä¸­ï¼Œ3ä¸ªåœ¨Top-5 â†’ âœ… R@5å‘½ä¸­
- 5ä¸ªæ­£ç¡®captionä¸­ï¼Œ1ä¸ªåœ¨Top-1 â†’ âœ… R@1å‘½ä¸­
```

---

## 4. ä¸ºä»€ä¹ˆè¿™æ˜¯æ’åºä»»åŠ¡è€Œä¸æ˜¯åˆ†ç±»ä»»åŠ¡ï¼Ÿ

### åˆ†ç±»ä»»åŠ¡çš„ç‰¹å¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           å¦‚æœè¿™æ˜¯åˆ†ç±»ä»»åŠ¡ï¼ˆå‡è®¾ï¼‰                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é¢„å®šä¹‰ç±»åˆ«:
- ç±»åˆ«1: åŠ¨ç‰©ç›¸å…³
- ç±»åˆ«2: è¿åŠ¨ç›¸å…³
- ç±»åˆ«3: é£æ™¯ç›¸å…³
- ç±»åˆ«4: äººç‰©ç›¸å…³
- ...

è¾“å…¥: ä¸€å¼ å›¾åƒ
è¾“å‡º: å±äºå“ªä¸ªç±»åˆ«ï¼ˆæ¦‚ç‡åˆ†å¸ƒï¼‰
æŸå¤±: CE Loss

é—®é¢˜:
âŒ 1. ç±»åˆ«æ˜¯å›ºå®šçš„ï¼Œæ— æ³•å¤„ç†ä»»æ„æ–‡æœ¬æŸ¥è¯¢
âŒ 2. ç±»åˆ«å®šä¹‰ä¸»è§‚ï¼Œè¾¹ç•Œæ¨¡ç³Š
âŒ 3. æ— æ³•å¤„ç†ç»†ç²’åº¦å·®å¼‚
       ä¾‹å¦‚: "A dog running" vs "A dog sleeping"
       éƒ½å±äº"åŠ¨ç‰©ç±»åˆ«"ï¼Œä½†æ£€ç´¢éœ€è¦åŒºåˆ†
âŒ 4. æ— æ³•æ³›åŒ–åˆ°æ–°çš„æ–‡æœ¬æè¿°
```

### æ£€ç´¢ä»»åŠ¡çš„ç‰¹å¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           SEPSçš„æ£€ç´¢ä»»åŠ¡ï¼ˆå®é™…ï¼‰                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å€™é€‰é›†åˆ: åŠ¨æ€ï¼ˆæµ‹è¯•æ—¶çš„ä»»æ„æ–‡æœ¬ï¼‰
- "A dog running on grass"
- "A cat sleeping on sofa"
- "A baseball player hitting ball"
- ... (å¯ä»¥æ˜¯ä»»æ„æ–°æ–‡æœ¬)

è¾“å…¥: ä¸€å¼ å›¾åƒ
è¾“å‡º: ä¸æ¯ä¸ªå€™é€‰æ–‡æœ¬çš„ç›¸ä¼¼åº¦ï¼ˆæ— éœ€å½’ä¸€åŒ–ï¼‰
æŸå¤±: Triplet Loss

ä¼˜åŠ¿:
âœ… 1. å€™é€‰é›†åˆåŠ¨æ€ï¼Œå¯ä»¥æ˜¯ä»»æ„æ–‡æœ¬
âœ… 2. ä¸éœ€è¦é¢„å®šä¹‰ç±»åˆ«
âœ… 3. ç»†ç²’åº¦åŒºåˆ†ï¼ˆåŒä¸€ä¸»é¢˜çš„ä¸åŒæè¿°ï¼‰
âœ… 4. å®Œå…¨æ³›åŒ–åˆ°æ–°æ–‡æœ¬
```

---

## 5. MSE Lossåœ¨L_ratioä¸­çš„ä½œç”¨

### çº¦æŸpatché€‰æ‹©æ¯”ä¾‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ä¸ºä»€ä¹ˆéœ€è¦L_ratio?                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é—®é¢˜: æ¨¡å‹å¯èƒ½å­¦ä¼š"å·æ‡’"
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ç­–ç•¥1: é€‰æ‹©æ‰€æœ‰patch (ratio=1.0)
    â†’ æ²¡æœ‰ç¨€ç–åŒ–ï¼Œå¤±å»SEPSçš„æ„ä¹‰
    â†’ è®¡ç®—å¼€é”€å¤§

ç­–ç•¥2: åªé€‰æ‹©1ä¸ªpatch (ratio=0.005)
    â†’ ä¿¡æ¯ä¸¢å¤±ä¸¥é‡
    â†’ æ€§èƒ½ä¸‹é™

ç­–ç•¥3: ä¸ç¨³å®šé€‰æ‹©
    Batch 1: é€‰æ‹©90%çš„patch
    Batch 2: é€‰æ‹©10%çš„patch
    â†’ è®­ç»ƒä¸ç¨³å®š

è§£å†³: L_ratioçº¦æŸ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

target_ratio = 0.5  # æœŸæœ›é€‰æ‹©50%

actual_ratio = score_mask.mean()  # å®é™…é€‰æ‹©çš„æ¯”ä¾‹

L_ratio = (actual_ratio - target_ratio) ** 2

æ•ˆæœ:
- å¦‚æœactual=0.9ï¼ŒL_ratio=(0.9-0.5)Â²=0.16 (å¤§æƒ©ç½š)
- å¦‚æœactual=0.5ï¼ŒL_ratio=(0.5-0.5)Â²=0 (æ— æƒ©ç½š)
- å¦‚æœactual=0.48ï¼ŒL_ratio=(0.48-0.5)Â²=0.0004 (å°æƒ©ç½š)

ç»“æœ: æ¨¡å‹ç¨³å®šé€‰æ‹©çº¦50%çš„patch
```

### ä¸ºä»€ä¹ˆMSEè€Œä¸æ˜¯å…¶ä»–æŸå¤±ï¼Ÿ

#### å¯¹æ¯”MAE Loss (L1 Loss)

```python
# MSE Loss (L2)
L_mse = (actual - target) ** 2

# MAE Loss (L1)
L_mae = |actual - target|

å¯¹æ¯”:
        actual=0.3  actual=0.48  actual=0.7
MSE:    0.04       0.0004       0.04
MAE:    0.2        0.02         0.2

æ¢¯åº¦:
MSE:    2*(actual-target)  # çº¿æ€§å¢é•¿
MAE:    sign(actual-target)  # å¸¸æ•°
```

**MSEä¼˜åŠ¿**:
- âœ… è¯¯å·®è¶Šå¤§ï¼Œæƒ©ç½šè¶Šé‡ï¼ˆäºŒæ¬¡å¢é•¿ï¼‰
- âœ… æ¢¯åº¦éšè¯¯å·®çº¿æ€§å¢é•¿ï¼Œä¼˜åŒ–æ›´å¿«
- âœ… æ•°å­¦æ€§è´¨å¥½ï¼Œæ˜“äºä¼˜åŒ–

**MAEåŠ£åŠ¿**:
- âŒ æ¢¯åº¦æ’å®šï¼Œè¯¯å·®å¤§å°ä¸å½±å“ä¼˜åŒ–é€Ÿåº¦
- âŒ åœ¨å°è¯¯å·®æ—¶ä¼˜åŒ–æ…¢

#### å¯¹æ¯”Huber Loss

```python
# Huber Loss (MSE + MAEç»“åˆ)
if |actual - target| < Î´:
    L = 0.5 * (actual - target) ** 2
else:
    L = Î´ * (|actual - target| - 0.5*Î´)
```

**Huberä¼˜åŠ¿**: å¯¹å¼‚å¸¸å€¼é²æ£’
**SEPSä¸éœ€è¦**: æ¯”ä¾‹çº¦æŸæ²¡æœ‰å¼‚å¸¸å€¼é—®é¢˜ï¼ŒMSEè¶³å¤Ÿ

---

## 6. å¯¹æ¯”å­¦ä¹  vs åˆ†ç±»å­¦ä¹ 

### å¯¹æ¯”å­¦ä¹  (Contrastive Learning)

SEPSä½¿ç”¨çš„èŒƒå¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               å¯¹æ¯”å­¦ä¹ ï¼šå­¦ä¹ ç›¸ä¼¼åº¦åº¦é‡                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è®­ç»ƒç›®æ ‡:
    å­¦ä¹ ä¸€ä¸ªembeddingç©ºé—´ï¼Œä½¿å¾—:
    - ç›¸ä¼¼æ ·æœ¬è·ç¦»è¿‘
    - ä¸ç›¸ä¼¼æ ·æœ¬è·ç¦»è¿œ

æŸå¤±å‡½æ•°:
    Triplet Loss / Contrastive Loss / NCE Loss

ç‰¹ç‚¹:
    âœ… æ— éœ€é¢„å®šä¹‰ç±»åˆ«
    âœ… æ³›åŒ–åˆ°æ–°æ ·æœ¬
    âœ… å­¦ä¹ é€šç”¨è¡¨ç¤º

åº”ç”¨:
    - å›¾åƒæ£€ç´¢
    - äººè„¸è¯†åˆ«
    - æ¨èç³»ç»Ÿ
    - è·¨æ¨¡æ€æ£€ç´¢ â† SEPS
```

### åˆ†ç±»å­¦ä¹  (Classification)

ä¼ ç»ŸèŒƒå¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               åˆ†ç±»å­¦ä¹ ï¼šé¢„æµ‹å›ºå®šç±»åˆ«                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è®­ç»ƒç›®æ ‡:
    å­¦ä¹ ä»è¾“å…¥åˆ°ç±»åˆ«çš„æ˜ å°„
    f(x) â†’ {class_1, class_2, ..., class_N}

æŸå¤±å‡½æ•°:
    Cross Entropy Loss

ç‰¹ç‚¹:
    âœ… é¢„æµ‹æ˜ç¡®
    âœ… è®­ç»ƒç®€å•
    âŒ éœ€è¦é¢„å®šä¹‰ç±»åˆ«
    âŒ æ— æ³•æ³›åŒ–åˆ°æ–°ç±»åˆ«

åº”ç”¨:
    - ImageNetåˆ†ç±»
    - æ–‡æœ¬æƒ…æ„Ÿåˆ†æ
    - è¯­éŸ³è¯†åˆ«
```

---

## 7. ä»»åŠ¡å¯¹æ¯”æ€»ç»“è¡¨

### SEPS vs å…¶ä»–å¸¸è§ä»»åŠ¡

| ä»»åŠ¡ | è¾“å…¥ | è¾“å‡º | æŸå¤±å‡½æ•° | å…¸å‹åº”ç”¨ |
|-----|------|------|---------|---------|
| **å›¾åƒåˆ†ç±»** | å›¾åƒ | ç±»åˆ«æ¦‚ç‡ | CE Loss | ImageNet |
| **ç›®æ ‡æ£€æµ‹** | å›¾åƒ | æ¡†+ç±»åˆ« | CE + Smooth L1 | YOLO, Faster R-CNN |
| **è¯­ä¹‰åˆ†å‰²** | å›¾åƒ | åƒç´ ç±»åˆ« | CE Loss | FCN, U-Net |
| **äººè„¸è¯†åˆ«** | äººè„¸ | ç›¸ä¼¼åº¦ | Triplet Loss | FaceNet |
| **å›¾åƒæ£€ç´¢** | å›¾åƒ+query | ç›¸ä¼¼åº¦æ’åº | Triplet Loss | Pinterestæœç´¢ |
| **SEPS** | å›¾åƒ+æ–‡æœ¬ | ç›¸ä¼¼åº¦æ’åº | **Triplet + MSE** | Flickr30K/COCOæ£€ç´¢ |

### æŸå¤±å‡½æ•°å†³ç­–æ ‘

```
ä½ çš„ä»»åŠ¡æ˜¯ä»€ä¹ˆ?

â”œâ”€ é¢„æµ‹å›ºå®šç±»åˆ« (å¦‚çŒ«/ç‹—/é¸Ÿ)
â”‚  â””â”€ ç”¨ CE Loss
â”‚      ä¾‹å­: ResNetåˆ†ç±»
â”‚
â”œâ”€ é¢„æµ‹è¿ç»­å€¼ (å¦‚ä»·æ ¼ã€æ¸©åº¦ã€æ¯”ä¾‹)
â”‚  â””â”€ ç”¨ MSE Loss æˆ– MAE Loss
â”‚      ä¾‹å­: æˆ¿ä»·é¢„æµ‹ã€SEPSçš„L_ratio
â”‚
â”œâ”€ æ’åº/æ£€ç´¢/åŒ¹é…
â”‚  â””â”€ ç”¨ Ranking Loss (Triplet/Contrastive/Hinge)
â”‚      ä¾‹å­: äººè„¸è¯†åˆ«ã€å›¾åƒæ£€ç´¢ã€SEPSçš„L_align
â”‚
â””â”€ ç”Ÿæˆä»»åŠ¡ (å¦‚æ–‡æœ¬ç”Ÿæˆ)
   â””â”€ ç”¨ CE Loss (tokençº§åˆ«åˆ†ç±»)
       ä¾‹å­: GPT, BERT MLM
```

---

## 8. æ•°æ®æµåŠ¨å®Œæ•´ç¤ºä¾‹

### å•ä¸ªæ ·æœ¬çš„å®Œæ•´å¤„ç†

```python
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          æ ·æœ¬: å°ç”·å­©è¸¢çƒ                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åŸå§‹æ•°æ®:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Image: flickr30k/1000092795.jpg (800Ã—600 pixels)
Sparse Caption: "A young boy kicking a soccer ball in a park."
Dense Caption: "A young boy approximately 6-8 years old is..."

é¢„å¤„ç†:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Image:
    resize â†’ (224, 224)
    normalize â†’ ImageNet mean/std
    to tensor â†’ (3, 224, 224)

Sparse Caption:
    tokenize â†’ ["[CLS]", "a", "young", "boy", ..., "[SEP]"]
    to ids â†’ [101, 1037, 2402, 2879, ..., 102]
    padding â†’ [101, 1037, ..., 102, 0, 0, ...]
    to tensor â†’ (30,)  # å›ºå®šé•¿åº¦

Dense Caption:
    tokenize â†’ ["[CLS]", "a", "young", "boy", "approximately", ...]
    to ids â†’ [101, 1037, 2402, 2879, 3155, ...]
    padding â†’ [101, 1037, ..., 102, 0, 0, ...]
    to tensor â†’ (200,)  # å›ºå®šé•¿åº¦

ç¼–ç :
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Image â†’ ViT:
    (3, 224, 224)
    â†’ split into 14Ã—14 patches
    â†’ (196 patches, 768 dim)
    â†’ add [CLS] token
    â†’ (197, 768)
    â†’ Linear projection
    â†’ (197, 512)

Sparse Caption â†’ BERT:
    (30,)  # token ids
    â†’ BERT embedding
    â†’ (30, 768)
    â†’ Linear projection
    â†’ (30, 512)

Dense Caption â†’ BERT:
    (200,)
    â†’ BERT embedding
    â†’ (200, 768)
    â†’ Linear projection
    â†’ (200, 512)

SEPSå¤„ç†:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

img_embs: (1, 197, 512)
cap_embs: (1, 30, 512)
long_cap_embs: (1, 200, 512)

    â†“ L2 Normalize

    â†“ åˆ†ç¦»[CLS]
img_patches: (1, 196, 512)

    â†“ è®¡ç®—æ³¨æ„åŠ›
s_im:  (1, 196)  # å›¾åƒè‡ªæ³¨æ„åŠ›
s_st:  (1, 196)  # ç¨€ç–æ–‡æœ¬æ³¨æ„åŠ›
s_dt:  (1, 196)  # ç¨ å¯†æ–‡æœ¬æ³¨æ„åŠ›

    â†“ TokenSparse (é€‰æ‹©)
select_tokens: (1, 98, 512)  # é€‰ä¸­50%
extra_token: (1, 1, 512)     # èåˆtoken
score_mask: (1, 196)         # [0,1,1,0,1,...] å†³ç­–

    â†“ TokenAggregation (èšåˆ)
aggr_tokens: (1, 39, 512)    # èšåˆåˆ°39ä¸ªpatch

    â†“ æ‹¼æ¥
final_tokens: (1, 41, 512)   # [CLS] + aggr(39) + extra(1)

    â†“ HRPA (å¯¹é½)
ç›¸ä¼¼åº¦çŸ©é˜µ A: (1, 30, 41)    # word-patchç›¸ä¼¼åº¦
S(I,T): 0.921                # å›¾åƒä¸ç¨€ç–æ–‡æœ¬ç›¸ä¼¼åº¦
S(I,T_dense): 0.887          # å›¾åƒä¸ç¨ å¯†æ–‡æœ¬ç›¸ä¼¼åº¦

    â†“ èåˆ
final_sim = 0.921 + 0.887 = 1.808
```

---

## 9. å…³é”®é—®ç­”

### Q1: ä¸ºä»€ä¹ˆL_alignä¸ç”¨CE Loss?

**A**: å› ä¸ºè¿™æ˜¯**æ’åºä»»åŠ¡**ï¼Œä¸æ˜¯**åˆ†ç±»ä»»åŠ¡**

- æ£€ç´¢: è®¡ç®—å›¾åƒä¸**ä»»æ„æ–‡æœ¬**çš„ç›¸ä¼¼åº¦
- åˆ†ç±»: é¢„æµ‹å›¾åƒå±äº**å›ºå®šç±»åˆ«**ä¸­çš„å“ªä¸€ä¸ª

CE Lossè¦æ±‚é¢„å®šä¹‰ç±»åˆ«ï¼Œæ£€ç´¢ä»»åŠ¡çš„å€™é€‰æ˜¯åŠ¨æ€çš„ã€‚

### Q2: ä¸ºä»€ä¹ˆL_ratioç”¨MSEä¸ç”¨CE?

**A**: å› ä¸ºæ¯”ä¾‹æ˜¯**è¿ç»­å€¼**ï¼Œä¸æ˜¯**ç¦»æ•£ç±»åˆ«**

- é€‰æ‹©æ¯”ä¾‹: 0.483, 0.501, 0.467, ... (è¿ç»­)
- å¦‚æœç”¨CE: å¿…é¡»ç¦»æ•£åŒ–ä¸ºç±»åˆ« (0-20%, 20-40%, ...)
- ç¦»æ•£åŒ–ä¸¢å¤±ç²¾åº¦ï¼Œä¸”ç±»åˆ«è¾¹ç•Œäººä¸º

MSEç›´æ¥ä¼˜åŒ–è¿ç»­å€¼ï¼Œæ›´è‡ªç„¶ã€‚

### Q3: Triplet Losså’ŒCE Lossèƒ½äº’æ¢å—ï¼Ÿ

**A**: ä¸èƒ½ï¼ä»»åŠ¡æ€§è´¨ä¸åŒ

| èƒ½å¦äº’æ¢ | Triplet Loss | CE Loss |
|---------|-------------|---------|
| **æ£€ç´¢ä»»åŠ¡** | âœ… å¤©ç„¶é€‚ç”¨ | âŒ æ— æ³•å¤„ç†åŠ¨æ€å€™é€‰ |
| **åˆ†ç±»ä»»åŠ¡** | ğŸŸ¡ å¯ä»¥ç”¨ï¼Œä½†å¤æ‚ | âœ… å¤©ç„¶é€‚ç”¨ |

### Q4: å…¶ä»–è·¨æ¨¡æ€æ£€ç´¢æ–¹æ³•ç”¨ä»€ä¹ˆæŸå¤±ï¼Ÿ

**A**: å‡ ä¹éƒ½ç”¨Triplet/Contrastive Loss

| æ–¹æ³• | æŸå¤±å‡½æ•° |
|-----|---------|
| VSE++ | Triplet Loss |
| SCAN | Contrastive Loss (=Triplet) |
| LAPS | Contrastive + KL Divergence |
| CLIP | Contrastive Loss (InfoNCE) |
| SEPS | **Triplet + MSE** |

**å…±åŒç‚¹**: ä¸»æŸå¤±éƒ½æ˜¯Triplet/Contrastiveï¼Œå› ä¸ºéƒ½æ˜¯æ£€ç´¢ä»»åŠ¡

---

## 10. å®é™…æ•°æ®åŠ è½½ç¤ºä¾‹

### DataLoaderè¾“å‡º

```python
from torch.utils.data import DataLoader

# åˆ›å»ºæ•°æ®é›†
train_dataset = RawImageDataset(
    opt=opt,
    data_path='data/',
    split='train',
    tokenizer=tokenizer,
    train=True
)

train_loader = DataLoader(
    train_dataset,
    batch_size=32,
    shuffle=True,
    num_workers=4
)

# è¿­ä»£ä¸€ä¸ªbatch
for batch in train_loader:
    images, captions, lengths, long_captions, long_lengths, ids, img_ids = batch

    print("Batch contents:")
    print(f"  images: {images.shape}")           # (32, 3, 224, 224)
    print(f"  captions: {captions.shape}")       # (32, 30)
    print(f"  lengths: {lengths.shape}")         # (32,)
    print(f"  long_captions: {long_captions.shape}")  # (32, 200)
    print(f"  long_lengths: {long_lengths.shape}")    # (32,)
    print(f"  ids: {ids.shape}")                 # (32,)
    print(f"  img_ids: {img_ids.shape}")         # (32,)

    # ç¬¬ä¸€ä¸ªæ ·æœ¬çš„è¯¦ç»†ä¿¡æ¯
    print("\nFirst sample:")
    print(f"  Image: tensor of shape {images[0].shape}")
    print(f"  Caption tokens: {captions[0][:lengths[0]]}")
    print(f"  Caption: {tokenizer.decode(captions[0][:lengths[0]])}")
    print(f"  Dense caption length: {long_lengths[0]} tokens")
    print(f"  Image ID: {img_ids[0]}")

    break

# è¾“å‡ºç¤ºä¾‹:
# Batch contents:
#   images: torch.Size([32, 3, 224, 224])
#   captions: torch.Size([32, 30])
#   lengths: torch.Size([32])
#   long_captions: torch.Size([32, 200])
#   long_lengths: torch.Size([32])
#   ids: torch.Size([32])
#   img_ids: torch.Size([32])
#
# First sample:
#   Image: tensor of shape torch.Size([3, 224, 224])
#   Caption tokens: tensor([101, 1037, 2402, 2879, ...])
#   Caption: [CLS] a young boy kicking a soccer ball in a park [SEP]
#   Dense caption length: 178 tokens
#   Image ID: 0
```

---

## æ€»ç»“

### ğŸ¯ æ ¸å¿ƒè¦ç‚¹

1. **ä»»åŠ¡æ€§è´¨**: è·¨æ¨¡æ€æ£€ç´¢ï¼ˆæ’åºä»»åŠ¡ï¼‰ï¼Œä¸æ˜¯åˆ†ç±»
2. **ä¸»æŸå¤±**: Triplet Lossï¼ˆå¯¹æ¯”æŸå¤±ï¼‰ï¼Œç”¨äºä¼˜åŒ–æ’åº
3. **è¾…åŠ©æŸå¤±**: MSE Lossï¼ˆæ¯”ä¾‹çº¦æŸï¼‰ï¼Œç”¨äºç¨³å®špatché€‰æ‹©
4. **ä¸ºä»€ä¹ˆä¸ç”¨CE**: ä»»åŠ¡ä¸æ˜¯åˆ†ç±»ï¼Œå€™é€‰é›†åŠ¨æ€ï¼Œè¾“å‡ºæ˜¯ç›¸ä¼¼åº¦ä¸æ˜¯æ¦‚ç‡

### ğŸ“Š SEPSå®Œæ•´æµç¨‹

```
è¾“å…¥: å›¾åƒ + ç¨€ç–æ–‡æœ¬ + ç¨ å¯†æ–‡æœ¬
  â†“ ç¼–ç å™¨
ç‰¹å¾: img_embs + cap_embs + long_cap_embs
  â†“ SEPSæ¨¡å—
ç›¸ä¼¼åº¦: S(I, T)
  â†“ æŸå¤±å‡½æ•°
L = Triplet Loss + MSE Loss
  â†“ ä¼˜åŒ–
æ¨¡å‹å‚æ•°æ›´æ–°
  â†“ æ¨ç†
æ£€ç´¢: ç»™å›¾æ‰¾æ–‡æœ¬ / ç»™æ–‡æœ¬æ‰¾å›¾
  â†“ è¯„ä¼°
R@1, R@5, R@10, rSum
```

### âœ… æŸå¤±å‡½æ•°æ€»ç»“

```python
# SEPSçš„æŸå¤±è®¾è®¡æ˜¯å®Œå…¨æ­£ç¡®çš„ï¼

SEPSLoss = {
    L_align: Triplet Loss  # ä¼˜åŒ–å›¾æ–‡æ£€ç´¢æ’åº
    L_ratio: MSE Loss      # çº¦æŸpatché€‰æ‹©æ¯”ä¾‹
}

ä¸éœ€è¦ä¹Ÿä¸åº”è¯¥ä½¿ç”¨CE Lossï¼
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æ—¥æœŸ**: 2025-12-04
