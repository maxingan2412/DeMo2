# ============================================================================
# DeMo + DGAF (Dual-Gated Adaptive Fusion) 配置
# 基于 AGFN 论文：Beyond Simple Fusion: Adaptive Gated Fusion
# ============================================================================
# 架构流程：
#   Backbone → SDTPS (token selection) → DGAF (自适应融合) → Classifier
#
# DGAF 位置：在 SDTPS 输出之后，替代简单的 concat
#   原始：sdtps_feat = concat([RGB_sdtps, NI_sdtps, TI_sdtps])
#   新版：sdtps_feat = DGAF(RGB_sdtps, NI_sdtps, TI_sdtps)
#
# DGAF 核心机制：
#   1. IEG (信息熵门控): 低熵=高确定性=高权重
#   2. MIG (模态重要性门控): 学习样本级别的模态重要性
#   3. 可学习 α 自适应平衡两个门控
# ============================================================================

MODEL:
  TRANSFORMER_TYPE: 'ViT-B-16'
  STRIDE_SIZE: [ 16, 16 ]
  SIE_CAMERA: True
  DIRECT: 1
  SIE_COE: 1.0
  ID_LOSS_WEIGHT: 0.25
  TRIPLET_LOSS_WEIGHT: 1.0
  GLOBAL_LOCAL: True

  # 禁用 HDM/ATM
  HDM: False
  ATM: False

  # ========== 模块开关 ==========
  USE_SACR: False                    # 禁用 SACR
  USE_LIF: False                     # 禁用 LIF
  USE_SDTPS: True                    # 启用 SDTPS（核心模块）
  USE_DGAF: True                     # 启用 DGAF（替代 concat）

  # ========== DGAF 参数 ==========
  DGAF_TAU: 1.0                      # 熵门控温度（越小越尖锐）
  DGAF_INIT_ALPHA: 0.5               # α 初始值（0.5 = IEG 和 MIG 平衡）

  # ========== SDTPS 参数 ==========
  SDTPS_SPARSE_RATIO: 0.7            # Token 保留比例
  SDTPS_AGGR_RATIO: 0.5              # 聚合比例
  SDTPS_BETA: 0.25                   # Score 组合权重
  SDTPS_USE_GUMBEL: False            # 禁用 Gumbel
  SDTPS_GUMBEL_TAU: 5.0              # Gumbel 温度
  SDTPS_LOSS_WEIGHT: 1.0             # SDTPS 损失权重（实验最优）

  # SACR 和 LIF 参数（已禁用）
  SACR_DILATION_RATES: [2, 3, 4]
  LIF_BETA: 0.4
  LIF_LOSS_WEIGHT: 0.2
  LIF_LAYER: 3

  HEAD: 4

INPUT:
  SIZE_TRAIN: [ 256, 128 ]
  SIZE_TEST: [ 256, 128 ]
  PROB: 0.5
  RE_PROB: 0.5
  PADDING: 10

DATALOADER:
  SAMPLER: 'softmax_triplet'
  NUM_INSTANCE: 8
  NUM_WORKERS: 14

DATASETS:
  NAMES: ('RGBNT201')
  ROOT_DIR: '..'

SOLVER:
  BASE_LR: 0.00035
  WARMUP_ITERS: 10
  MAX_EPOCHS: 50
  OPTIMIZER_NAME: 'Adam'
  IMS_PER_BATCH: 64
  EVAL_PERIOD: 1

TEST:
  IMS_PER_BATCH: 128
  RE_RANKING: 'no'
  WEIGHT: ''
  NECK_FEAT: 'before'
  FEAT_NORM: 'yes'
  MISS: "nothing"

OUTPUT_DIR: '..'

# ============================================================================
# 运行命令：
#   python train_net.py --config_file configs/RGBNT201/DeMo_DGAF.yml \
#       --exp_name "sdtps_dgaf"
#
# 对比实验（验证 DGAF 的效果）：
#   # Baseline: SDTPS only (concat)
#   python train_net.py --config_file configs/RGBNT201/DeMo_DGAF.yml \
#       --exp_name "sdtps_concat" MODEL.USE_DGAF False
#
#   # With DGAF
#   python train_net.py --config_file configs/RGBNT201/DeMo_DGAF.yml \
#       --exp_name "sdtps_dgaf" MODEL.USE_DGAF True
#
# 预期效果：
#   DGAF 通过双门控机制，相比简单 concat：
#   - 更好地抑制噪声/低质量模态
#   - 自适应调整模态贡献权重
#   - 提升对模态缺失/不一致的鲁棒性
# ============================================================================
